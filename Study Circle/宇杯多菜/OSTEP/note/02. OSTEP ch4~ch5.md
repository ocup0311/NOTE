# ã€å®‡å¤šæ¯èœæœƒå–‡è³½ 3 ï¼šOSTEP ch4~ch6ã€‘

> å–‡è³½æ—¥æœŸï¼š12/4
> å–‡è³½äººå“¡ï¼šæ¯ã€å¤š
> å–‡è³½æ™‚é–“ï¼š20:00 ~ 21:00
> ä¸»æŒå–‡è³½äººï¼šå¤šå¤š
>
> å–‡è³½å…§å®¹ï¼š
> I. [OSTEP](https://github.com/remzi-arpacidusseau/ostep-translations/tree/master/chinese)
>
> - ch4 æŠ½è±¡ï¼šè™•ç†ç¨‹åº (The Abstraction: The Process)
> - ch5 æ’æ›²ï¼šè™•ç†ç¨‹åº APIï¼ˆInterlude: Process APIï¼‰
> - ch6 æ©Ÿåˆ¶:å—é™ç›´æ¥åŸ·è¡Œï¼ˆMechanism: Limited Direct Executionï¼‰
>
> II. [ä½œæ¥­](https://github.com/remzi-arpacidusseau/ostep-homework/) | [è§£ç­”](https://github.com/jzplp/OSTEP-Answers)
>
> IV. å…¶ä»–è³‡æº
>
> - [åŸæ–‡æ›¸](https://pages.cs.wisc.edu/~remzi/OSTEP/)
> - æ›¸æœ¬ code: [ostep-code](https://github.com/remzi-arpacidusseau/ostep-code)
> - [åè©å°ç…§è¡¨](https://hackmd.io/@e_Me9JgsS1y8VahM1nF7wg/Skk8y3u8j)

---

## ch4 The Abstraction: The Process

- <mark>TODO:å¾…ç¢ºèª</mark>`$ ls -la /dev`ï¼šå¯æŸ¥çœ‹æ‰€æœ‰çš„ process

### 4.0

- æƒ³æ›´å¥½åœ°å¯¦ä½œ CPU Virtualizationï¼Œéœ€è¦ä½éšçš„`mechanism`èˆ‡é«˜éšçš„`policy`

### 4.1 The Abstraction: A Process

- åœ¨ä»»ä½•æ™‚åˆ»ï¼Œæˆ‘å€‘éƒ½å¯ä»¥æ¸…é»å®ƒåœ¨åŸ·è¡Œéç¨‹ä¸­ è¨ªå•æˆ–å½±éŸ¿çš„ç³»çµ±çš„ä¸åŒéƒ¨åˆ†ï¼Œå¾è€Œæ¦‚æ‹¬ä¸€å€‹ Processã€‚

- ç‚ºäº†ç†è§£ Process çš„æ§‹æˆï¼Œå¿…é ˆå…ˆç†è§£å®ƒçš„ machine state

  - <mark>TODO:Q</mark> machine state ç´€éŒ„åœ¨å“ªè£¡ï¼Ÿ

- `åˆ†é›¢ mechanism èˆ‡ policy`ï¼šå°‡ mechanism èˆ‡ policy åˆ†é–‹ï¼Œå°±å¯ä»¥è¼•é¬†åœ°æ”¹è®Š policy ä¸å½±éŸ¿ mechanismã€‚

### 4.2 Process API

- ç¾ä»£ OS éƒ½ä»¥æŸç¨®å½¢å¼æä¾› createã€destroyã€waitã€miscellaneous controlã€statu ç­‰ç­‰ API

<!-- Q & A -->

- <details close>
  <summary>Q & A</summary>

  - Q: ä¸€å€‹ program æ˜¯æœƒæ‹†æˆè¨±å¤šå€‹ process?é‚„æ˜¯å°±åªä¸€å€‹ï¼Ÿ
    - æœ€åˆå§‹å°±æ˜¯ä¸€å€‹ processï¼Œä½†åœ¨ program ä¸­å¯èƒ½åŒ…å«ä¸€äº›å¦‚ fork çš„æŒ‡ä»¤ï¼Œå†åˆ†åŒ–å‡ºæ›´å¤š process

  </details>

### 4.3 Process Creation: A Little More Detail

- <mark>Q: å¾ä¸‹æ®µä¸­ï¼Œæ‰€ä»¥åœ¨ç”¢ç”Ÿ process æ™‚ï¼Œä»–ä¸æ˜¯åœ¨åˆå§‹åŒ–æ™‚ï¼Œå°±å·²ç¶“é å…ˆåˆ†é…å¥½éœ€è¦çš„ memory å—ï¼Ÿä¹‹å¾Œå†åˆ†é…çš„è©±ï¼Œç‚ºå•¥æœƒ stack overflow?è¶…éç¸½ memory å®¹é‡å—ï¼Ÿ</mark>

  > éš¨è‘—ç¨‹åºé‹è¡Œï¼Œé€šé malloc()åº« API è«‹æ±‚æ›´å¤šå…§å­˜ï¼Œæ“ä½œç³»çµ±å¯èƒ½æœƒåƒèˆ‡åˆ†é…æ›´å¤šå…§å­˜çµ¦é€²ç¨‹ï¼Œ ä»¥æ»¿è¶³é€™äº›èª¿ç”¨ã€‚

- <mark>Q: file descriptor æ˜¯å•¥é¬¼ï¼Ÿ</mark>

<!-- Q & A -->

- <details close>
  <summary>Q & A</summary>

  </details>

### 4.4 Process States

- Process æœ‰å„å¼å„æ¨£çš„ç‹€æ…‹

  - RUNNING: æ­£ä½¿ç”¨ CPU ä¸­ã€‚
  - READY: éš¨æ™‚æº–å‚™å¯ä»¥ä½¿ç”¨ CPUã€‚
  - BLOCKED: ç­‰å¾… IO ä¸­ã€‚
  - DONE: å®ŒæˆåŸ·è¡Œã€‚

- <mark>Q: èª°å»èªªå¯ä»¥æ›ä¸‹ä¸€å€‹ process ä¾†ï¼ŸCPU è‡ªå·±æ²’äº‹çš„æ™‚å€™å»å• process ç®¡ç†è€…ï¼Ÿ</mark>

- æ–°å¢ Process æ™‚ï¼ŒOS ä¸»è¦æœƒåšçš„äº‹ï¼š

  - å°‡ç¨‹å¼åŠéœæ…‹è³‡æ–™å¾ç£ç¢Ÿè®€å‡ºå¾Œè¼‰å…¥ memoryã€‚
  - ç‚ºç¨‹å¼ run-time stack or stack åˆ†é… memoryã€‚
  - ç‚ºç¨‹å¼çš„ heap åˆ†é… memoryã€‚
    - ç•¶æœ‰å‘¼å« malloc() æ™‚ï¼Œæœƒåˆ†é…æ›´å¤š memory ã€‚
  - å…¶ä»–åˆå§‹åŒ–ä»»å‹™ï¼Œå¦‚ file descriptor ï¼Œæ–¹ä¾¿ process è®€ terminal çš„è¼¸å…¥åŠè¼¸å‡ºã€‚
  - å•Ÿå‹• main ã€‚

### 4.5 Data Structures

- OS ä¹Ÿæ˜¯ä¸€éš»ç¨‹å¼ï¼Œæœ‰ä¸€äº›é—œéµçš„è³‡æ–™çµæ§‹è¿½è¹¤ç›¸é—œè¨Šæ¯ã€‚

- OS å¿…é ˆè¿½è¹¤æ¯å€‹ process ç‚ºäº†åƒæ˜¯ç•¶æœ‰ process åœæ­¢æ™‚ï¼Œå°‡é€™å€‹ process çš„å¯„å­˜å™¨ä¿å­˜è‡³å…§å­˜ä½ç½®ï¼Œæ–¹ä¾¿ä¹‹å¾Œæ¢å¾© process ã€‚é€™åˆç¨±ä½œ context switch ã€‚

### # Homework

- æ­¸ç´ï¼š

  - åˆå§‹è¨­å®šä¸‹ï¼Œç•¶æ²’æœ‰ `i/o` æ™‚ï¼Œå°±æœƒä¸€ç›´åŒä¸€å€‹ `process` åœ¨ä½¿ç”¨ `CPU`
  - é è¨­æ¯æ¬¡ `i/o` éœ€è¦ 5 time
  - `io_done` ä¹Ÿéœ€è¦ 1 time
  - åˆå§‹è¨­å®šä¸‹ï¼ŒæœƒæŒ‰ç…§æŒ‡ä»¤é †åºåŸ·è¡Œ
  - `SWITCH_ON_END`: `process` å®Œå…¨åŸ·è¡Œå®Œæ‰æ›ä¸‹ä¸€å€‹

- Q:
  - ç‚ºå•¥`RUN:io_done`è¦åŠ  `*` è™Ÿ

æ ¹æ“šä¸åŒ Run `process-run.py` æƒ³æ¨¡æ“¬çš„æƒ…å¢ƒï¼Œè©¦è‘—é æ¸¬ process é‹ä½œæ–¹å¼è·Ÿ CPU ä½¿ç”¨ç‡

1. `./process-run.py -l 5:100,5:100`

   - CPU ä½¿ç”¨ç‡æ˜¯ 100%ï¼Œå› ç‚ºä¾åºåŸ·è¡Œå…©å€‹æ²’æœ‰ç™¼ç”Ÿ BLOCKING çš„ processã€‚

2. `./process-run.py -l 4:100,1:0`

   - ~~100%? å› ç‚ºå¦ä¸€å€‹ process ä¸æœƒç”¨åˆ° CPU~~
   - 6 /11 = 54.55%

   ```bash
           Time        PID: 0        PID: 1           CPU           IOs
             1        RUN:cpu         READY             1
             2        RUN:cpu         READY             1
             3        RUN:cpu         READY             1
             4        RUN:cpu         READY             1
             5           DONE        RUN:io             1
             6           DONE       BLOCKED                           1
             7           DONE       BLOCKED                           1
             8           DONE       BLOCKED                           1
             9           DONE       BLOCKED                           1
            10           DONE       BLOCKED                           1
            11*          DONE   RUN:io_done             1

           Stats: Total Time 11
           Stats: CPU Busy 6 (54.55%)
           Stats: IO Busy  5 (45.45%)
   ```

3. `./process-run.py -l 1:0,4:100`

   - ~~100% å› ç‚ºåœ¨ CPU ç­‰å¾…çš„æ™‚å€™ï¼Œå»åšç¬¬äºŒå€‹ process çš„äº‹æƒ…~~
   - 6 / 7 = 85.71%

   ```bash
           Time        PID: 0        PID: 1           CPU           IOs
             1         RUN:io         READY             1
             2        BLOCKED       RUN:cpu             1             1
             3        BLOCKED       RUN:cpu             1             1
             4        BLOCKED       RUN:cpu             1             1
             5        BLOCKED       RUN:cpu             1             1
             6        BLOCKED          DONE                           1
             7*   RUN:io_done          DONE             1

           Stats: Total Time 7
           Stats: CPU Busy 6 (85.71%)
           Stats: IO Busy  5 (71.43%)
   ```

4. `./process-run.py -l 1:0,4:100 -c -S SWITCH_ON_END `

   - 54.55%ï¼Œå¯èƒ½è·Ÿ `./process-run.py -l 4:100,1:0` ä¸€æ¨£ï¼Œä½†ä¸çŸ¥é“ç„¡æ³•åˆ‡æ›ä½† CPU æœ‰ä¸åšäº‹æ€éº¼ç®—ï¼Ÿ
     - å°±æ²’æœ‰ç®—é‹ä½œï¼Œä½†å°±ç„¡æ³•ä½µç™¼ã€‚

5. `./process-run.py -l 1:0,4:100 -c -S SWITCH_ON_IO`

   - CPU ä½¿ç”¨ç‡æ‡‰è©²æœƒæ›´é«˜ã€‚
   - æ™‚é–“ç¸®çŸ­
   - 6 / 7 = 85.71%
   - çœ‹ä¾†é è¨­å°±æ˜¯æœ‰åŠ  `SWITCH_ON_IO`

6. `./process-run.py -l 3:0,5:100,5:100,5:100 -S SWITCH_ON_IO -I IO_RUN_LATER -c -p`

   - æ„Ÿè¦ºé€™ç¨®æœ‰æ©Ÿæœƒé‡åˆ° dead lock
   - é è¨­ä¹Ÿæ˜¯ `IO_RUN_LATER`

7. `./process-run.py -l 3:0,5:100,5:100,5:100 -S SWITCH_ON_IO -I IO_RUN_IMMEDIATE -c -p`

   - ç‚ºä»€éº¼é‹è¡Œä¸€å€‹å‰›å‰›å®Œæˆ I/O çš„é€²ç¨‹æœƒæ˜¯ä¸€å€‹å¥½ä¸»æ„?

   > ç¶²å‹èªªï¼šå› ç‚ºæœ‰é IO æ“ä½œçš„é€²ç¨‹å¾ˆæœ‰å¯èƒ½å¾Œé¢ä¹Ÿæœƒé€²è¡Œ IO æ“ä½œï¼Œç‚ºäº†ä½¿ CPU æœ‰æ•ˆåˆ©ç”¨ï¼Œæ‡‰è©²åœ¨ IO çµæŸä¸ä¹…å¾Œé‹è¡Œè©²é€²ç¨‹ï¼Œä½¿å…¶å¾—åˆ°ç¹¼çºŒé˜»å¡ IO çš„æ©Ÿæœƒã€‚
   > æˆ‘èªªï¼šç‚ºå•¥æœ‰é IO æ“ä½œçš„é€²ç¨‹å¾ˆæœ‰å¯èƒ½å¾Œé¢ä¹Ÿæœƒé€²è¡Œ IO æ“ä½œï¼Ÿ

8. `./process-run.py -s 1 -l 3:50,3:50, -s 2 -l 3:50,3:50, -s 3 -l 3:50,3:50`

---

## ch5 Interlude: Process API

### Process API

**fork()**

Parent åœ¨ fork() çš„è¿”å›å€¼æ˜¯æ–°å‰µå»ºçš„ child çš„ pid ï¼Œè€Œ child åœ¨ fork() å¾Œçš„è¿”å›å€¼æ˜¯ 0 ã€‚fork å¾Œï¼Œå°æ–¼ OS ä¾†èªªï¼Œæœ‰å…©å€‹å¹¾ä¹ä¸€æ¨¡ä¸€æ¨£çš„ process åœ¨åŸ·è¡Œã€‚

Child ä¸æœƒå¾ main é–‹å§‹åŸ·è¡Œï¼Œè€Œæ˜¯å¾ fork() å¾Œé–‹å§‹ï¼Œå°±åƒè‡ªå·±å‘¼å«é fork() ä¸€æ¨£ã€‚

æ ¹æ“šä¸åŒçš„ scheduler ï¼Œ åœ¨ parent è·Ÿ child çš„è™•ç†æœ‰ä¸åŒçš„å…ˆå¾Œé †åºã€‚

**wait()**

åˆ©ç”¨ wait() å¯ä»¥å¼·åˆ¶è®“ Parent ~~æˆ–æ˜¯ child ~~å¼·åˆ¶ç­‰ child çµæŸå†åŸ·è¡Œã€‚BUT ä¹Ÿè¦æ³¨æ„ä¸æ˜¯çµ•å°ã€‚ï¼ˆé–‹ç™¼æ™‚è«‹åƒé–±~~å…¬é–‹èªªæ˜æ›¸~~manï¼‰

**exec()**

åŸ·è¡Œä¸­çš„ process è—‰ç”± load code å’Œè³‡æ–™ä¾†è¦†å¯«è‡ªå·±ã€‚

- Q: strdup() ä¸èƒ½ç”¨ç›¸å°è·¯å¾‘ (p3.c)
  - åŸä¾†ç›¸å°è·¯å¾‘è·Ÿç·¨è­¯å¾Œçš„ fileã€.c file éƒ½ç„¡é—œï¼Œæ˜¯è·Ÿ terminal æ‰€åœ¨ä½ç½®æœ‰é—œ
- Q: p4
  - 1.  ä¸è¦ redirect -> é€šé€šå°å‡ºä¾†
  - 2.  redirect -> åªå°å‡º exec çµæœ
  - 3.  redirect + å¤šæ¢ printf -> å…¨éƒ¨å°å‡ºä¾†

### # Homework

1.  - `fork()`æ“æœ‰è‡ªå·±çš„ç©ºé–“ï¼Œä¸è·Ÿ parent é‡ç–Š
2.  - process æ˜¯ç´€éŒ„ä»€éº¼ï¼Ÿ
    - é‡æ–° open å† write æœƒè¦†è“‹æ•´å€‹ fileï¼Œclose å¾Œå°±ç„¡æ³• write
    - ä½†æ¯å€‹ fork ä¸­ close å¾Œï¼Œä¸å½±éŸ¿å…¶ä»– process çš„ write

3.  - å¯ä»¥ï¼Œå·ç”¨ `sleep()`ï¼Œä½†ä¸æ˜¯çœŸçš„ã€‚
    - æ˜¯å¦æœ‰å…¶ä»–æ–¹æ³•ï¼Ÿæ­£è¦æ„Ÿè¦ºå°±æ˜¯ç”¨ `wait()`
    - ç¶²å‹ï¼šä½¿ç”¨`vfork()`ï¼Œchild çµæŸå¾Œæ‰æœƒåŸ·è¡Œ parentã€‚
      - warning: 'vfork' is deprecated: Use posix_spawn or fork [-Wdeprecated-declarations]

4.  -

5.  - `wait()`è¿”å›ç­‰å¾…çš„ pidã€‚(child pid)
    - è‹¥æ²’æœ‰ child å‰‡è¿”å› -1

6.  - `waitpid()`ç”¨åœ¨å·²çŸ¥ child pid
    - [REF](https://wirelessr.gitbooks.io/working-life/content/wait_vs_waitpid.html) ä½†æˆ‘è¦ºå¾—ç¾åœ¨å¥½åƒä¸æœƒå‡ºç¾å¥¹æè¿°çš„å•é¡Œ? å› ç‚ºå°±ç®—æˆ‘åœ¨ child é‚£é‚Š wait ä¹Ÿä¸æœƒå¡ä½ï¼Œä»–æœƒå›å‚³ -1

**1. Main process ä¸­å¦‚æœæœ‰è®Šæ•¸ï¼Œfork å¾Œ parent å’Œ child å»æ”¹è®Šä»–æœƒæœ‰ä»€éº¼æƒ…æ³ï¼Ÿ**

fork å¾Œï¼Œç„¡è«– parent æˆ– child èª° wait èª°ï¼Œèª°å»æ”¹é‚£å€‹è®Šæ•¸éƒ½ä¸æœƒå½±éŸ¿åˆ°å°æ–¹ã€‚

**2. æ‰“é–‹æ–‡ä»¶å¾Œå† fork æœƒå° parent å’Œ child æœ‰ä»€éº¼å½±éŸ¿ï¼Ÿ**

Parent å’Œ child éƒ½å¯ä»¥è¨ªå•æ–‡ä»¶ï¼Œä¹Ÿéƒ½å¯ä»¥å¯«å…¥ã€‚

**3. æ‰¿ä¸Šé¡Œï¼Œå¦‚æœæƒ³è¦ child å° helloï¼Œparent å° goodbye ï¼Œæœ‰è¾¦æ³•ä¸é  wait åšåˆ°é€™é»å—ï¼Ÿ**

æ²’æœ‰æƒ³æ³•ã€‚

**4. exec() ç³»åˆ—å‡½æ•¸çš„æ„ç¾©ï¼Ÿ**

æœ‰ç”¨åˆ°å†çœ‹å¥½ ğŸ¤ªã€‚

- [Linux ç³»çµ±ç·¨ç¨‹ä¹‹é€²ç¨‹ï¼ˆäº”ï¼‰ï¼šexec ç³»åˆ—å‡½æ•¸ï¼ˆexecl,execlp,execle,execv,execvp)ä½¿ç”¨](https://jasonblog.github.io/note/linux_system/linuxxi_tong_bian_cheng_zhi_jin_cheng_ff08_wu_ff09.html)
- [execlpã€execvp ç”¨æ³•èˆ‡ç¯„ä¾‹])(https://burweisnote.blogspot.com/2017/08/execlpexecvp.html)

**5. fork() å¾Œï¼Œwait() æœƒè¿”å›ä»€éº¼ï¼Ÿå¦‚æœ child ç”¨çš„è©±æœƒæ€æ¨£ï¼Ÿ**

åœ¨ parent ç”¨ wait() æœƒå¾—åˆ° child çš„ process idï¼›åœ¨ child ç”¨ wait æœƒå¾—åˆ° -1ã€‚ï¼›å…©å€‹åŒæ™‚ç”¨ child çš„ wait æœƒå¾—åˆ° -1ï¼Œè€Œ parent æœƒå¾—åˆ° child çš„ process idã€‚

**6. waitpid()**

waitpid() éœ€è¦çµ¦å®š pid åŠå›å‚³ç‹€æ…‹ï¼Œè®“ parent çŸ¥é“è¦ç­‰åˆ°ä»€éº¼æ™‚å€™ã€‚

- [wait vs. waitpid](https://wirelessr.gitbooks.io/working-life/content/wait_vs_waitpid.html)
- [linux ä¸­ waitpid åŠ wait çš„ç”¨æ³•](https://www.twblogs.net/a/5b83317c2b717766a1eb53be)

**7. å¦‚æœåœ¨ child é—œé–‰ STDOUT_FILENO å¾Œï¼Œprintf æœƒå‡ºç¾ä»€éº¼ï¼Ÿ**
